name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.2"
      - name: Build
        run: swift build
      - name: Compile generated output (template regression check)
        run: |
          mkdir -p /tmp/sskeys-ci-test

          # XOR mode (works on both platforms)
          printf 'keys:\n  CI_KEY: test-value\n  CI_SECRET: another\n' > /tmp/sskeys-ci-test/sskeys.yml
          swift run sskeys generate --config /tmp/sskeys-ci-test/sskeys.yml --output-dir /tmp/sskeys-ci-test
          swiftc -parse /tmp/sskeys-ci-test/SecretKeys.swift

          # AES-GCM mode (macOS only — needs CryptoKit via SDK)
          if [[ "$(uname)" == "Darwin" ]]; then
            printf 'cipher: aes-gcm\nkeys:\n  CI_KEY: test-value\n  CI_SECRET: another\n' > /tmp/sskeys-ci-test/sskeys-aes.yml
            swift run sskeys generate --config /tmp/sskeys-ci-test/sskeys-aes.yml --output-dir /tmp/sskeys-ci-test
            swiftc -sdk "$(xcrun --show-sdk-path)" -typecheck /tmp/sskeys-ci-test/SecretKeys.swift

            # ChaCha20-Poly1305 mode (macOS only — needs CryptoKit via SDK)
            printf 'cipher: chacha20\nkeys:\n  CI_KEY: test-value\n  CI_SECRET: another\n' > /tmp/sskeys-ci-test/sskeys-chacha20.yml
            swift run sskeys generate --config /tmp/sskeys-ci-test/sskeys-chacha20.yml --output-dir /tmp/sskeys-ci-test
            swiftc -sdk "$(xcrun --show-sdk-path)" -typecheck /tmp/sskeys-ci-test/SecretKeys.swift
          fi
      - name: Integration test (SPM Build Tool Plugin)
        run: swift build --package-path IntegrationFixture
      - name: Test with coverage
        run: swift test --enable-code-coverage
      - name: Report coverage
        run: |
          BIN_PATH=$(swift build --show-bin-path)
          XCTEST_PATH=$(find "$BIN_PATH" -name '*.xctest' | head -1)
          if [[ "$(uname)" == "Darwin" ]]; then
            COV_BIN="$XCTEST_PATH/Contents/MacOS/$(basename "$XCTEST_PATH" .xctest)"
            LLVM_COV="xcrun llvm-cov"
          else
            COV_BIN="$XCTEST_PATH"
            LLVM_COV="llvm-cov"
          fi
          $LLVM_COV report \
            "$COV_BIN" \
            -instr-profile=.build/debug/codecov/default.profdata \
            -ignore-filename-regex=".build|Tests"
